<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Server Dashboard 2025</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<style>
    body { font-family: 'Segoe UI', sans-serif; background: #0d0d0d; color: #fff; }
    h1 { text-align: center; margin: 30px 0 10px 0; font-size: 35px; font-weight: 600; letter-spacing: 2px; color: #00d0ff; }
    .stats { width: 94%; margin: 25px auto; display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; }
    .stat-card { background: #1a1a1a; border-left: 4px solid #00d0ff; padding: 15px; border-radius: 8px; box-shadow: 0 0 15px rgba(0,0,0,0.5); }
    .stat-card h3 { margin: 0 0 10px 0; color: #00ffd5; font-size: 16px; }
    .stat-card p { margin: 8px 0; font-size: 12px; color: #aaa; line-height: 1.5; }
    #container { width: 94%; margin: auto; display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 25px; margin-top: 35px; }
    .card { background: #121212; border-radius: 18px; padding: 20px; box-shadow: 0 0 25px #000 inset; }
    .card h2 { text-align: center; font-size: 22px; margin-bottom: 10px; color: #00ffd5; }
    canvas { height: 220px !important; }
    #services { grid-column: span -1; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { padding: 12px; text-align: center; background: #1b1b1b; border-bottom: 1px solid #333; font-size: 14px; }
    th { background: #00aaff; color: #000; font-weight: 600; }
    button { width: 200px; height: 45px; background: #ff004c; border: none; color: white; border-radius: 10px; font-size: 17px; cursor: pointer; transition: 0.3s; margin-top: 20px; display: block; margin-left: auto; margin-right: auto; }
    button:hover { background: #ff336d; transform: scale(1.05); }
    .social-container { display: flex; justify-content: center; gap: 15px; flex-wrap: wrap; margin: 30px 0; }
    .social-btn { padding: 12px 25px; border-radius: 25px; text-decoration: none; font-weight: 600; display: inline-flex; align-items: center; gap: 8px; transition: 0.3s ease; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3); border: none; cursor: pointer; font-size: 14px; }
    .github-btn { background: linear-gradient(135deg, #333, #555); color: #fff; }
    .github-btn:hover { transform: translateY(-3px); box-shadow: 0 6px 20px rgba(100, 100, 100, 0.6); }
    .facebook-btn { background: linear-gradient(135deg, #1877f2, #0a66c2); color: #fff; }
    .facebook-btn:hover { transform: translateY(-3px); box-shadow: 0 6px 20px rgba(24, 119, 242, 0.6); }
    .youtube-btn { background: linear-gradient(135deg, #ff0000, #cc0000); color: #fff; }
    .youtube-btn:hover { transform: translateY(-3px); box-shadow: 0 6px 20px rgba(255, 0, 0, 0.6); }
    .tiktok-btn { background: linear-gradient(135deg, #000000, #25f4ee); color: #fff; }
    .tiktok-btn:hover { transform: translateY(-3px); box-shadow: 0 6px 20px rgba(0, 0, 0, 0.8); }
    .instagram-btn { background: linear-gradient(135deg, #fd1d1d, #833ab4); color: #fff; }
    .instagram-btn:hover { transform: translateY(-3px); box-shadow: 0 6px 20px rgba(253, 29, 29, 0.6); }
    footer { text-align: center; margin: 40px 0 20px 0; }
    .dropdown-toggle { background: #1877f2; color: #fff; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 13px; font-weight: 600; }
    .dropdown-toggle:hover { background: #0d5cb8; }
    .dropdown-content { display: none; position: relative; margin-top: 10px; }
    .dropdown-content.active { display: block; }
    .group-item { background: #1a1a1a; padding: 10px; margin: 5px 0; border-radius: 5px; border-left: 3px solid #1877f2; font-size: 12px; }
    .facebook-section { background: #121212; padding: 15px; border-radius: 8px; margin: 20px 0; }
    .facebook-section h3 { color: #00ffd5; margin-top: 0; }
    @media (max-width: 768px) { #container { grid-template-columns: 1fr; } #services { grid-column: span 1; } .stats { grid-template-columns: 1fr; } }
</style>
</head>
<body>

<h1>üöÄ Facebook Automation Dashboard ‚Äî 2025</h1>

<!-- Quick Stats Section -->
<div class="stats">
  <div class="stat-card">
    <h3>üíæ RAM</h3>
    <p id="ram-info">Loading...</p>
  </div>
  <div class="stat-card">
    <h3>‚ö° CPU</h3>
    <p id="cpu-info">Loading...</p>
  </div>
  <div class="stat-card">
    <h3>üíø Hard Disk</h3>
    <p id="disk-info">Loading...</p>
  </div>
  <div class="stat-card">
    <h3>üåê Network</h3>
    <p id="network-info">Loading...</p>
  </div>
</div>

<div id="container">

    <!-- CPU -->
    <div class="card">
        <h2>CPU Usage</h2>
        <canvas id="cpuChart"></canvas>
    </div>

    <!-- RAM -->
    <div class="card">
        <h2>RAM Usage</h2>
        <canvas id="ramChart"></canvas>
    </div>

    <!-- DISK -->
    <div class="card">
        <h2>Disk Usage</h2>
        <canvas id="diskChart"></canvas>
    </div>

    <!-- NETWORK -->
    <div class="card">
        <h2>Network (Real‚ÄëTime)</h2>
        <canvas id="netChart"></canvas>
    </div>

    <!-- DISK CLEANUP BUTTON -->
    <div class="card">
        <h2>Disk Cleanup</h2>
        <button onclick="cleanupDisk()" style="background: #00ff62; color: #000;">Clean Disk Cache</button>
    </div>

    <!-- RESTART BUTTON -->
    <div class="card">
        <h2>Controls</h2>
        <button onclick="restartServer()">Restart Server</button>
    </div>

    <!-- SERVICES TABLE -->
    <div class="card" id="services">
        <h2>Active Services</h2>
        <table id="servicesTable">
            <tr>
                <th>Proto</th>
                <th>Local Address</th>
                <th>State</th>
                <th>PID/Program</th>
            </tr>
        </table>
    </div>

    <!-- FACEBOOK MANAGEMENT SECTION -->
    <div style="width: 94%; margin: 30px auto;">
        <div class="facebook-section">
            <h3>üì± Facebook Posting & Groups Management</h3>
            
            <!-- Token Status -->
            <div style="margin-bottom: 15px; padding: 10px; background: #1a1a1a; border-radius: 5px;">
                <button onclick="validateTokens()" style="background: #1877f2; color: #fff; width: 100%; padding: 8px; border: none; border-radius: 5px; cursor: pointer; font-size: 12px;">üîç Check Facebook Tokens</button>
                <p id="token-status" style="font-size: 11px; color: #888; margin: 8px 0;"></p>
            </div>

            <!-- Post to Page -->
            <div style="margin-bottom: 15px;">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                  <img id="page-profile-pic" src="" alt="Page Profile" style="width: 50px; height: 50px; border-radius: 50%; background: #1a1a1a; border: 2px solid #00ffd5; object-fit: cover; display: none;">
                  <h4 style="color: #00ffd5; margin: 0; flex: 1;">üìÑ Post to IT-Solutions Page</h4>
                </div>
                <input type="text" id="fb-message" placeholder="Enter your message..." style="width: 100%; padding: 8px; margin: 8px 0; border-radius: 5px; border: 1px solid #333; background: #1a1a1a; color: #fff; box-sizing: border-box;">
                <input type="text" id="fb-link" placeholder="Optional link..." style="width: 100%; padding: 8px; margin: 8px 0; border-radius: 5px; border: 1px solid #333; background: #1a1a1a; color: #fff; box-sizing: border-box;">
                <div style="display: flex; gap: 8px; margin: 8px 0; flex-wrap: wrap;">
                  <div style="flex: 1; min-width: 100px; position: relative;">
                    <label for="fb-photo" style="display: block; padding: 6px; background: #1a1a1a; color: #999; border: 1px solid #333; border-radius: 5px; font-size: 11px; cursor: pointer; text-align: center; transition: 0.3s;">
                      üì∑ Select Photo
                    </label>
                    <input type="file" id="fb-photo" accept="image/*" style="display: none;" onchange="trackMediaUpload('photo')">
                    <span id="photo-status" style="display: block; font-size: 9px; color: #00ff62; margin-top: 2px;"></span>
                  </div>
                  <div style="flex: 1; min-width: 100px; position: relative;">
                    <label for="fb-video" style="display: block; padding: 6px; background: #1a1a1a; color: #999; border: 1px solid #333; border-radius: 5px; font-size: 11px; cursor: pointer; text-align: center; transition: 0.3s;">
                      üé• Select Video
                    </label>
                    <input type="file" id="fb-video" accept="video/*" style="display: none;" onchange="trackMediaUpload('video')">
                    <span id="video-status" style="display: block; font-size: 9px; color: #00ff62; margin-top: 2px;"></span>
                  </div>
                </div>
                <div id="media-progress" style="display: none; margin: 8px 0; padding: 8px; background: #1a1a1a; border-radius: 5px; border-left: 3px solid #00ff62;">
                  <div style="font-size: 11px; color: #00ff62; margin-bottom: 5px;">üì§ Session: <span id="session-id" style="color: #fff; font-weight: bold;"></span></div>
                  <div style="width: 100%; height: 4px; background: #333; border-radius: 2px; overflow: hidden;">
                    <div id="upload-progress-bar" style="height: 100%; width: 0%; background: linear-gradient(90deg, #00ff62, #00ffd5); transition: width 0.3s;"></div>
                  </div>
                  <div style="font-size: 9px; color: #888; margin-top: 3px;">
                    <span id="file-info">Ready...</span>
                  </div>
                </div>
                <button onclick="postToFacebook()" style="background: #1877f2; color: #fff; width: 100%; padding: 10px; border: none; border-radius: 5px; cursor: pointer; margin: 8px 0; font-weight: 600;">üì§ Post to Page</button>
                <p id="fb-status" style="font-size: 11px; color: #888; margin: 5px 0;"></p>
            </div>

            <!-- Groups Section -->
            <div>
                <button class="dropdown-toggle" onclick="toggleGroupsDropdown()">üë• Post to Facebook Groups</button>
                <div id="groups-dropdown" class="dropdown-content">
                    <div style="margin-bottom: 10px; padding: 8px; background: #1a1a1a; border-radius: 5px;">
                        <h5 style="color: #00ffd5; margin: 0 0 8px 0; font-size: 12px;">Method 1: Auto-Sync (if available)</h5>
                        <button onclick="autoSyncGroups()" style="background: #1877f2; color: #fff; width: 100%; padding: 8px; border: none; border-radius: 5px; cursor: pointer; font-weight: 600;">üîÑ Auto-Sync Groups</button>
                        <div id="groups-status" style="margin-top: 8px; max-height: 150px; overflow-y: auto; font-size: 11px; color: #888;"></div>
                    </div>

                    <div style="margin-bottom: 10px; padding: 8px; background: #1a1a1a; border-radius: 5px;">
                        <h5 style="color: #00ffd5; margin: 0 0 8px 0; font-size: 12px;">Method 2: Manual Group IDs</h5>
                        <textarea id="manual-group-ids" placeholder="Enter Group IDs (comma or line separated)&#10;Example: 123456789, 987654321" style="width: 100%; height: 50px; padding: 8px; margin: 8px 0; border-radius: 5px; border: 1px solid #333; background: #0a0a0a; color: #fff; font-family: monospace; font-size: 11px; box-sizing: border-box;"></textarea>
                        <button onclick="loadManualGroups()" style="background: #1877f2; color: #fff; width: 100%; padding: 8px; border: none; border-radius: 5px; cursor: pointer; margin-bottom: 8px;">Load Group IDs</button>
                    </div>
                    
                    <select id="groups-select" style="width: 100%; padding: 8px; margin: 8px 0; border-radius: 5px; border: 1px solid #333; background: #1a1a1a; color: #fff; box-sizing: border-box;">
                        <option value="">Select a group to post to...</option>
                    </select>
                    
                    <textarea id="group-message" placeholder="Enter message for group..." style="width: 100%; height: 60px; padding: 8px; margin: 8px 0; border-radius: 5px; border: 1px solid #333; background: #1a1a1a; color: #fff; box-sizing: border-box;"></textarea>
                    
                    <button onclick="postToSelectedGroup()" style="background: #1877f2; color: #fff; width: 100%; padding: 8px; border: none; border-radius: 5px; cursor: pointer; margin-bottom: 10px;">üì§ Post to Selected Group</button>
                    
                    <p id="group-post-status" style="font-size: 11px; color: #888; margin-top: 8px;"></p>
                </div>
            </div>
        </div>
    </div>

</div>

<footer>
    <h3 style="color: #00ffd5; margin-bottom: 15px;">Connect With Me</h3>
    <div class="social-container">
        <a href="https://kutt.it/SolutionsFB" target="_blank" class="social-btn facebook-btn">
            üëç Facebook
        </a>
        <a href="https://kutt.it/SolutionsYT" target="_blank" class="social-btn youtube-btn">
            ‚ñ∂Ô∏è YouTube
        </a>
        <a href="https://kutt.it/SolutionsTT" target="_blank" class="social-btn tiktok-btn">
            üéµ TikTok
        </a>
        <a href="https://kutt.it/SolutionsIG" target="_blank" class="social-btn instagram-btn">
            üì∏ Instagram
        </a>
        <a href="https://github.com/Mohamedsafwat93" target="_blank" class="social-btn github-btn">
            üöÄ GitHub
        </a>
    </div>
    <p style="color: #888; font-size: 14px; margin-top: 20px;">Made With Love ‚ù§Ô∏è By Eng. Muhammed Safwat</p>
</footer>

<script>
function gradient(ctx, c1, c2) {
    let g = ctx.createLinearGradient(0, 0, 0, 250);
    g.addColorStop(0, c1);
    g.addColorStop(1, c2);
    return g;
}

let cpuChart, ramChart, diskChart, netChart;
let uploadSession = null;
let mediaTracking = { photo: null, video: null };

// Initialize upload session on page load
function initializeUploadSession() {
  const sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
  uploadSession = {
    id: sessionId,
    timestamp: new Date(),
    device: navigator.userAgent.split('(')[1]?.split(')')[0] || 'Unknown Device',
    mediaItems: []
  };
  localStorage.setItem('uploadSession', JSON.stringify(uploadSession));
  document.getElementById('session-id').innerText = sessionId.substr(0, 12) + '...';
  console.log('‚úÖ Upload Session Initialized:', sessionId);
}

// Track media file selection
function trackMediaUpload(type) {
  const inputId = type === 'photo' ? 'fb-photo' : 'fb-video';
  const statusId = type === 'photo' ? 'photo-status' : 'video-status';
  const input = document.getElementById(inputId);
  const statusEl = document.getElementById(statusId);
  const file = input.files[0];
  
  if(!file) {
    statusEl.innerText = '';
    mediaTracking[type] = null;
    return;
  }
  
  const sizeMB = (file.size / 1024 / 1024).toFixed(2);
  const maxMB = type === 'video' ? 100 : 50;
  
  if(file.size > maxMB * 1024 * 1024) {
    statusEl.innerText = `‚ùå File too large (${sizeMB}MB > ${maxMB}MB)`;
    statusEl.style.color = '#ff3333';
    input.value = '';
    mediaTracking[type] = null;
    return;
  }
  
  mediaTracking[type] = {
    name: file.name,
    size: sizeMB,
    type: file.type,
    lastModified: new Date(file.lastModified)
  };
  
  statusEl.innerText = `‚úÖ ${file.name} (${sizeMB}MB)`;
  statusEl.style.color = '#00ff62';
  
  document.getElementById('media-progress').style.display = 'block';
  
  // Track in session
  uploadSession.mediaItems.push({
    type: type,
    filename: file.name,
    size: sizeMB,
    selectedAt: new Date()
  });
  localStorage.setItem('uploadSession', JSON.stringify(uploadSession));
  console.log(`‚úÖ ${type.toUpperCase()} tracked:`, file.name, `(${sizeMB}MB)`);
}

async function loadStats() {
    try {
        const res = await fetch("/api/stats?t=" + Date.now());
        const data = await res.json();

        let cpu = data.cpu?.usage || 0;
        let ram = ((data.ram.used / data.ram.total) * 100).toFixed(1);
        let disk = data.disk && data.disk[0] ? ((data.disk[0].used / data.disk[0].size) * 100).toFixed(1) : 0;
        let net = Math.floor(Math.random() * 100);

        updateChart("cpuChart", "CPU Usage", cpu, cpuChart, x => cpuChart = x, "#ff2a2a", "#ff7b00");
        updateChart("ramChart", "RAM Usage", ram, ramChart, x => ramChart = x, "#00ff62", "#00d9ff");
        updateChart("diskChart", "Disk Usage", disk, diskChart, x => diskChart = x, "#c300ff", "#ff009d");
        updateChart("netChart", "Network Speed", net, netChart, x => netChart = x, "#00c8ff", "#003cff");

        updateServices(data.services || []);
    } catch(e) {
        console.error("Error loading stats:", e);
    }
}

function updateChart(id, label, value, instance, saveFn, c1, c2) {
    const ctx = document.getElementById(id).getContext("2d");

    if (!instance) {
        saveFn(new Chart(ctx, {
            type: "doughnut",
            data: {
                labels: ["Used", "Free"],
                datasets: [{
                    data: [value, 100 - value],
                    backgroundColor: [gradient(ctx, c1, c2), "#2a2a2a"],
                    borderWidth: 0
                }]
            },
            options: {
                cutout: "70%",
                plugins: {
                    tooltip: { enabled: true },
                    title: {
                        display: true,
                        text: label,
                        color: "#fff",
                        font: { size: 18 }
                    }
                }
            }
        }));
    } else {
        instance.data.datasets[0].data = [value, 100 - value];
        instance.update();
    }
}

function updateServices(list) {
    let table = document.getElementById("servicesTable");

    table.innerHTML = `
        <tr>
            <th>Proto</th>
            <th>Local Address</th>
            <th>State</th>
            <th>PID/Program</th>
        </tr>
    `;

    if (list && list.length > 0) {
        list.forEach(s => {
            table.innerHTML += `
            <tr>
                <td>${s.proto || 'N/A'}</td>
                <td>${s.localAddress || 'N/A'}</td>
                <td>${s.state || 'N/A'}</td>
                <td>${s.pid_program || 'N/A'}</td>
            </tr>
            `;
        });
    } else {
        table.innerHTML += '<tr><td colspan="4">No services data available</td></tr>';
    }
}

function restartServer() {
    const password = prompt("üîí Enter password to restart server:");
    
    if(password === null) {
        return; // User cancelled
    }
    
    if(password === "") {
        alert("‚ùå Password cannot be empty");
        return;
    }
    
    fetch("/api/restart", { 
        method: "POST",
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ password: password })
    })
    .then(res => res.json())
    .then(data => {
        if(data.error) {
            alert("‚ùå " + data.error);
        } else {
            alert("‚úÖ " + data.message);
        }
    })
    .catch(err => alert("‚ùå Error: " + err.message));
}

function cleanupDisk() {
    const password = prompt("üîí Enter password to cleanup disk cache:");
    
    if(password === null) {
        return; // User cancelled
    }
    
    if(password === "") {
        alert("‚ùå Password cannot be empty");
        return;
    }
    
    fetch("/api/cleanup", { 
        method: "POST",
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ password: password })
    })
    .then(res => res.json())
    .then(data => {
        if(data.error) {
            alert("‚ùå " + data.error);
        } else {
            let message = "‚úÖ " + data.message + "\n\n";
            if(data.results) {
                message += data.results.join("\n");
            }
            alert(message);
        }
    })
    .catch(err => alert("‚ùå Error: " + err.message));
}

async function postToFacebook() {
    const message = document.getElementById('fb-message').value.trim();
    const link = document.getElementById('fb-link').value.trim();
    const photoFile = document.getElementById('fb-photo').files[0];
    const videoFile = document.getElementById('fb-video').files[0];
    const statusEl = document.getElementById('fb-status');
    const progressBar = document.getElementById('upload-progress-bar');
    const fileInfo = document.getElementById('file-info');
    
    if(!message) {
        statusEl.innerText = '‚ùå Message cannot be empty';
        return;
    }
    
    statusEl.innerText = '‚è≥ Publishing...';
    progressBar.style.width = '0%';
    
    try {
        const formData = new FormData();
        formData.append('message', message);
        formData.append('sessionId', uploadSession.id);
        
        if(link) formData.append('link', link);
        if(photoFile) {
            formData.append('photo', photoFile);
            fileInfo.innerText = `üì∑ Photo: ${photoFile.name}`;
        }
        if(videoFile) {
            formData.append('video', videoFile);
            fileInfo.innerText = `üé• Video: ${videoFile.name}`;
        }
        
        // Simulate upload progress
        let progress = 0;
        const progressInterval = setInterval(() => {
            if(progress < 90) {
                progress += Math.random() * 30;
                progressBar.style.width = Math.min(progress, 90) + '%';
            }
        }, 200);
        
        const response = await fetch("/api/facebook/post", {
            method: "POST",
            body: formData
        });
        
        clearInterval(progressInterval);
        
        const data = await response.json();
        
        if(data.success) {
            progress = 100;
            progressBar.style.width = '100%';
            statusEl.innerText = '‚úÖ ' + data.message;
            fileInfo.innerText = `‚úÖ Post ID: ${data.postId}`;
            
            // Update session
            uploadSession.postPublished = {
                postId: data.postId,
                publishedAt: new Date(),
                message: message
            };
            localStorage.setItem('uploadSession', JSON.stringify(uploadSession));
            
            // Clear form after 3 seconds
            setTimeout(() => {
                document.getElementById('fb-message').value = '';
                document.getElementById('fb-link').value = '';
                document.getElementById('fb-photo').value = '';
                document.getElementById('fb-video').value = '';
                document.getElementById('photo-status').innerText = '';
                document.getElementById('video-status').innerText = '';
                statusEl.innerText = '';
                fileInfo.innerText = 'Ready...';
                progressBar.style.width = '0%';
                mediaTracking = { photo: null, video: null };
                initializeUploadSession();
            }, 3000);
        } else {
            progressBar.style.width = '0%';
            statusEl.innerText = '‚ùå ' + (data.error || 'Failed to post');
            fileInfo.innerText = data.error || 'Upload failed';
        }
    } catch(err) {
        progressBar.style.width = '0%';
        statusEl.innerText = '‚ùå Error: ' + err.message;
        fileInfo.innerText = err.message;
    }
}

async function autoSyncGroups() {
    const statusEl = document.getElementById('groups-status');
    const selectEl = document.getElementById('groups-select');
    statusEl.innerHTML = '‚è≥ Syncing your Facebook groups...';
    
    try {
        const response = await fetch("/api/facebook/auto-groups");
        const data = await response.json();
        
        if(!response.ok) {
            statusEl.innerHTML = '‚ùå ' + (data.error || 'Failed to sync groups');
            if(data.suggestion) {
                statusEl.innerHTML += '<br><small style="color: #ffaa00;">' + data.suggestion + '</small>';
            }
            return;
        }
        
        if(data.groups && data.groups.length > 0) {
            // Populate dropdown
            selectEl.innerHTML = '<option value="">Select a group to post to...</option>';
            data.groups.forEach(group => {
                const option = document.createElement('option');
                option.value = group.id;
                option.text = group.name + ' (' + (group.member_count || 0) + ' members)';
                option.dataset.name = group.name;
                selectEl.appendChild(option);
            });
            
            // Update status
            statusEl.innerHTML = `<p style="color: #00ff62;">‚úÖ Synced ${data.total} groups successfully!</p>`;
            
            // Show group list
            let html = '<div style="margin-top: 10px;">';
            data.groups.forEach(group => {
                html += `<div style="background: #1a1a1a; padding: 8px; margin: 5px 0; border-radius: 5px; border-left: 3px solid #1877f2; font-size: 11px;">
                    <strong style="color: #00ffd5;">${group.name}</strong><br>
                    <small style="color: #888;">Members: ${group.member_count || 'N/A'} | Privacy: ${group.privacy || 'N/A'}</small>
                </div>`;
            });
            html += '</div>';
            statusEl.innerHTML = `<p style="color: #00ff62;">‚úÖ Synced ${data.total} groups! Select one above to post.</p>` + html;
        } else {
            statusEl.innerHTML = '‚ùå No groups found.<br><small style="color: #ffaa00;">Your token may not have "groups_manage" permission.<br>Try regenerating your Facebook token with full permissions.</small>';
        }
    } catch(err) {
        statusEl.innerHTML = '‚ùå Error: ' + err.message;
        console.error('Sync error:', err);
    }
}

function loadManualGroups() {
    const idsText = document.getElementById('manual-group-ids').value.trim();
    const selectEl = document.getElementById('groups-select');
    const statusEl = document.getElementById('group-post-status');
    
    if(!idsText) {
        statusEl.innerText = '‚ùå Please enter at least one group ID';
        return;
    }
    
    // Parse group IDs
    const groupIds = idsText.split(/[,\n]/).map(id => id.trim()).filter(id => id);
    
    if(groupIds.length === 0) {
        statusEl.innerText = '‚ùå No valid group IDs found';
        return;
    }
    
    // Clear and populate dropdown
    selectEl.innerHTML = '<option value="">Select a group to post to...</option>';
    groupIds.forEach(id => {
        const option = document.createElement('option');
        option.value = id;
        option.text = 'Group: ' + id;
        selectEl.appendChild(option);
    });
    
    statusEl.innerText = '‚úÖ Loaded ' + groupIds.length + ' group ID(s). Select one and post!';
}

async function postToSelectedGroup() {
    const selectEl = document.getElementById('groups-select');
    const groupId = selectEl.value;
    const message = document.getElementById('group-message').value.trim();
    const photoFile = document.getElementById('fb-photo')?.files[0];
    const videoFile = document.getElementById('fb-video')?.files[0];
    const statusEl = document.getElementById('group-post-status');
    
    if(!groupId) {
        statusEl.innerText = '‚ùå Please select a group';
        return;
    }
    
    if(!message) {
        statusEl.innerText = '‚ùå Please enter a message';
        return;
    }
    
    const groupName = selectEl.options[selectEl.selectedIndex].text;
    statusEl.innerText = '‚è≥ Posting to ' + groupName + '...';
    
    try {
        const formData = new FormData();
        formData.append('group_id', groupId);
        formData.append('message', message);
        if(photoFile) formData.append('photo', photoFile);
        if(videoFile) formData.append('video', videoFile);
        
        const response = await fetch("/api/facebook/group-post", {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if(!response.ok || data.error) {
            statusEl.innerText = '‚ùå ' + (data.error || 'Failed to post');
            console.error('Post error:', data);
        } else {
            statusEl.innerText = '‚úÖ Posted successfully to ' + groupName + '!';
            document.getElementById('group-message').value = '';
            setTimeout(() => { statusEl.innerText = ''; }, 3000);
        }
    } catch(err) {
        statusEl.innerText = '‚ùå Error: ' + err.message;
        console.error('Fetch error:', err);
    }
}

function toggleGroupsDropdown() {
    const dropdown = document.getElementById('groups-dropdown');
    dropdown.classList.toggle('active');
}

async function validateTokens() {
    const statusEl = document.getElementById('token-status');
    statusEl.innerText = '‚è≥ Checking tokens...';
    
    try {
        const response = await fetch("/api/facebook/validate-token");
        const data = await response.json();
        
        let statusText = '';
        
        if(data.page_token?.valid) {
            statusText += '‚úÖ Page Token: Valid (' + data.page_token.name + ')\n';
        } else {
            statusText += '‚ùå Page Token: ' + (data.page_token?.error || 'Invalid');
            if(data.auto_page_token?.available) {
                statusText += ' (Using auto-generated page token)\n';
            } else {
                statusText += '\n';
            }
        }
        
        if(data.user_token?.valid) {
            statusText += '‚úÖ User Token: Valid (' + data.user_token.name + ')\n';
        } else {
            statusText += '‚ùå User Token: ' + (data.user_token?.error || 'Invalid') + '\n';
        }
        
        if(data.auto_page_token?.available) {
            statusText += '‚ú® Auto-Generated: Page found "' + data.auto_page_token.page_name + '" - Posting enabled!';
        }
        
        statusEl.innerHTML = statusText.replace(/\n/g, '<br>');
    } catch(err) {
        statusEl.innerText = '‚ùå Error: ' + err.message;
    }
}

function postToGroup(groupId, groupName) {
    const message = prompt(`üí¨ Enter message for "${groupName}":`);
    if(!message) return;
    
    fetch("/api/facebook/group-post", {
        method: "POST",
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
            group_id: groupId,
            message: message
        })
    })
    .then(res => res.json())
    .then(data => {
        if(data.success) {
            alert('‚úÖ Posted to ' + groupName);
        } else {
            alert('‚ùå Error: ' + (data.error || 'Failed to post'));
        }
    })
    .catch(err => alert('‚ùå Error: ' + err.message));
}

// Startup: Initialize session and load stats
document.addEventListener('DOMContentLoaded', () => {
  initializeUploadSession();
  console.log('üì± Device Info:', navigator.userAgent);
  console.log('üåê Platform:', navigator.platform);
});

// Load page profile picture on startup
async function loadPageProfilePicture() {
  try {
    const response = await fetch("/api/facebook/page-info");
    const data = await response.json();
    
    if(data.success && data.page.picture) {
      const img = document.getElementById('page-profile-pic');
      img.src = data.page.picture;
      img.style.display = 'block';
      img.title = data.page.name;
    }
  } catch(err) {
    console.log('Could not load page picture:', err.message);
  }
}

loadPageProfilePicture();

setInterval(loadStats, 1500);
loadStats();

// Quick Stats Update
async function updateQuickStats() {
  try {
    const res = await fetch("/api/server-stats?t=" + Date.now());
    const data = await res.json();

    const ramUsed = (data.ram.used / 1024 / 1024).toFixed(2);
    const ramTotal = (data.ram.total / 1024 / 1024).toFixed(2);
    const ramFree = (ramTotal - ramUsed).toFixed(2);
    document.getElementById('ram-info').innerText = `Used: ${ramUsed} MB\nFree: ${ramFree} MB\nTotal: ${ramTotal} MB`;

    document.getElementById('cpu-info').innerText = `Usage: ${data.cpu.percent}%\nCores: ${data.cpu.cores}`;

    const diskUsed = (data.disk.used / 1024 / 1024 / 1024).toFixed(2);
    const diskTotal = (data.disk.total / 1024 / 1024 / 1024).toFixed(2);
    const diskFree = (diskTotal - diskUsed).toFixed(2);
    document.getElementById('disk-info').innerText = `Used: ${diskUsed} GB\nFree: ${diskFree} GB\nTotal: ${diskTotal} GB`;
  } catch(e) {
    console.error('Quick stats error:', e);
  }
}

// Network Stats Update
async function updateNetworkStats() {
  try {
    const res = await fetch("/api/stats?t=" + Date.now());
    const data = await res.json();
    
    const net = data.network || { rx_sec: 0, tx_sec: 0 };
    const download = (net.rx_sec / 1024 / 1024).toFixed(2); // Convert to MB/s
    const upload = (net.tx_sec / 1024 / 1024).toFixed(2);   // Convert to MB/s
    const speed = (Math.max(parseFloat(download), parseFloat(upload))).toFixed(2);
    
    document.getElementById('network-info').innerText = `Download: ${download} MB/s\nUpload: ${upload} MB/s\nSpeed: ${speed} MB/s`;
  } catch(e) {
    console.error('Network stats error:', e);
  }
}

setInterval(updateQuickStats, 1000);
updateQuickStats();

setInterval(updateNetworkStats, 1000);
updateNetworkStats();
</script>

</body>
</html>
