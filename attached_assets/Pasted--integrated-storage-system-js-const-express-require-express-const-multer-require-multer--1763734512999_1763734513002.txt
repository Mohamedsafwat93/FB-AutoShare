// integrated-storage-system.js
const express = require('express');
const multer = require('multer');
const { Client } = require('minio');
const sharp = require('sharp');
const axios = require('axios');
const path = require('path');

const app = express();

// ğŸ”§ ØªÙƒÙˆÙŠÙ† MinIO
const minioClient = new Client({
    endPoint: 'localhost',
    port: 9000,
    useSSL: false,
    accessKey: 'minioadmin',
    secretKey: 'minioadmin'
});

// ğŸ“ Ø¥Ù†Ø´Ø§Ø¡ Buckets ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
async function initializeBuckets() {
    const buckets = ['facebook-posts', 'facebook-images', 'facebook-videos', 'backups'];
    
    for (const bucket of buckets) {
        try {
            const exists = await minioClient.bucketExists(bucket);
            if (!exists) {
                await minioClient.makeBucket(bucket);
                console.log(`âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Bucket: ${bucket}`);
            }
        } catch (error) {
            console.log(`â„¹ï¸ ${bucket} Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹`);
        }
    }
}

// ğŸ–¼ï¸ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ± Ù…Ø¹ Sharp
async function processImage(imageBuffer) {
    try {
        // Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ù…ØµØºØ±Ø©
        const thumbnail = await sharp(imageBuffer)
            .resize(300, 300)
            .jpeg({ quality: 80 })
            .toBuffer();
            
        // Ù†Ø³Ø®Ø© Ù…ØªÙˆØ³Ø·Ø© Ø§Ù„Ø¬ÙˆØ¯Ø©
        const optimized = await sharp(imageBuffer)
            .resize(1200, 1200, { fit: 'inside' })
            .jpeg({ quality: 85 })
            .toBuffer();
            
        return { thumbnail, optimized };
    } catch (error) {
        throw new Error('ÙØ´Ù„ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ±Ø©: ' + error.message);
    }
}

// ğŸ“¤ Ø±ÙØ¹ Ù…Ù„Ù Ø¥Ù„Ù‰ MinIO
async function uploadToMinIO(fileBuffer, bucketName, fileName, metadata = {}) {
    try {
        const objectName = `${Date.now()}-${fileName}`;
        
        await minioClient.putObject(
            bucketName,
            objectName,
            fileBuffer,
            fileBuffer.length,
            {
                'Content-Type': metadata.contentType || 'application/octet-stream',
                'Original-Name': fileName,
                'Upload-Date': new Date().toISOString(),
                ...metadata
            }
        );

        const fileUrl = `http://localhost:9000/${bucketName}/${objectName}`;
        
        return {
            success: true,
            objectName,
            bucketName,
            url: fileUrl,
            size: fileBuffer.length
        };
    } catch (error) {
        return { success: false, error: error.message };
    }
}

// ğŸ”„ Ø±ÙØ¹ Ù…ØªÙƒØ§Ù…Ù„ Ù„Ù„ÙÙŠØ³Ø¨ÙˆÙƒ + MinIO
async function integratedUpload(file, options = {}) {
    const { compressImages = true, createBackup = true } = options;
    
    try {
        const results = {
            original: null,
            processed: null,
            facebook: null,
            backup: null
        };

        const fileName = file.originalname;
        const fileType = file.mimetype.split('/')[0]; // image, video, etc
        
        // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù€ Bucket Ø§Ù„Ù…Ù†Ø§Ø³Ø¨
        let targetBucket = 'facebook-posts';
        if (fileType === 'image') targetBucket = 'facebook-images';
        if (fileType === 'video') targetBucket = 'facebook-videos';

        // ğŸ“¥ 1. Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø£ØµÙ„ÙŠ Ø¥Ù„Ù‰ MinIO
        results.original = await uploadToMinIO(
            file.buffer, 
            targetBucket, 
            fileName,
            { 'Content-Type': file.mimetype }
        );

        // ğŸ–¼ï¸ 2. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ± Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ù„Ù ØµÙˆØ±Ø©
        if (fileType === 'image' && compressImages) {
            const processedImages = await processImage(file.buffer);
            
            // Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…Ø­Ø³Ù†Ø©
            results.processed = await uploadToMinIO(
                processedImages.optimized,
                targetBucket,
                `optimized-${fileName}`,
                { 'Content-Type': 'image/jpeg' }
            );

            // Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…ØµØºØ±Ø©
            await uploadToMinIO(
                processedImages.thumbnail,
                targetBucket,
                `thumbnail-${fileName}`,
                { 'Content-Type': 'image/jpeg' }
            );
        }

        // ğŸ“± 3. Ø±ÙØ¹ Ø¥Ù„Ù‰ Ø§Ù„ÙÙŠØ³Ø¨ÙˆÙƒ (ÙŠÙ…ÙƒÙ† ØªÙØ¹ÙŠÙ„Ù‡ Ù„Ø§Ø­Ù‚Ø§Ù‹)
        /*
        if (options.uploadToFacebook) {
            results.facebook = await uploadToFacebook(
                results.processed ? results.processed.buffer : file.buffer
            );
        }
        */

        // ğŸ’¾ 4. Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
        if (createBackup) {
            results.backup = await uploadToMinIO(
                file.buffer,
                'backups',
                `backup-${fileName}`,
                { 'Content-Type': file.mimetype }
            );
        }

        return {
            success: true,
            message: 'âœ… ØªÙ… Ø§Ù„Ø±ÙØ¹ ÙˆØ§Ù„ØªØ®Ø²ÙŠÙ† Ø¨Ù†Ø¬Ø§Ø­',
            results: results
        };

    } catch (error) {
        return {
            success: false,
            error: 'ÙØ´Ù„ Ø§Ù„Ø±ÙØ¹ Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„: ' + error.message
        };
    }
}

// ğŸ“‹ Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ù…Ù„ÙØ§Øª
async function getFilesList(bucketName) {
    try {
        const files = [];
        const stream = minioClient.listObjects(bucketName, '', true);
        
        for await (const file of stream) {
            const url = await minioClient.presignedGetObject(bucketName, file.name, 24*60*60);
            files.push({
                name: file.name,
                size: file.size,
                lastModified: file.lastModified,
                url: url
            });
        }
        
        return files;
    } catch (error) {
        throw new Error('ÙØ´Ù„ ÙÙŠ Ø³Ø±Ø¯ Ø§Ù„Ù…Ù„ÙØ§Øª: ' + error.message);
    }
}

// ğŸ—‘ï¸ Ø­Ø°Ù Ù…Ù„Ù
async function deleteFile(bucketName, fileName) {
    try {
        await minioClient.removeObject(bucketName, fileName);
        return { success: true, message: 'âœ… ØªÙ… Ø§Ù„Ø­Ø°Ù Ø¨Ù†Ø¬Ø§Ø­' };
    } catch (error) {
        return { success: false, error: error.message };
    }
}

// ğŸŒ Ø¥Ø¹Ø¯Ø§Ø¯ Routes
app.use(express.json());
const upload = multer({ storage: multer.memoryStorage() });

// ğŸ“¤ Route Ù„Ù„Ø±ÙØ¹ Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„
app.post('/api/upload', upload.single('file'), async (req, res) => {
    try {
        if (!req.file) {
            return res.status(400).json({ error: 'Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù' });
        }

        const result = await integratedUpload(req.file, {
            compressImages: true,
            createBackup: true,
            uploadToFacebook: false // ØºÙŠØ± Ù‡Ø°Ø§ Ø¥Ù„Ù‰ true Ø¹Ù†Ø¯Ù…Ø§ ØªØ¶ÙŠÙ Ø§Ù„ÙÙŠØ³Ø¨ÙˆÙƒ
        });

        res.json(result);
    } catch (error) {
        res.status(500).json({ error: error.message });
    }
});

// ğŸ“ Route Ù„Ø³Ø±Ø¯ Ø§Ù„Ù…Ù„ÙØ§Øª
app.get('/api/files/:bucket', async (req, res) => {
    try {
        const files = await getFilesList(req.params.bucket);
        res.json({ success: true, files: files });
    } catch (error) {
        res.status(500).json({ error: error.message });
    }
});

// ğŸ—‘ï¸ Route Ù„Ù„Ø­Ø°Ù
app.delete('/api/files/:bucket/:filename', async (req, res) => {
    try {
        const result = await deleteFile(req.params.bucket, req.params.filename);
        res.json(result);
    } catch (error) {
        res.status(500).json({ error: error.message });
    }
});

// ğŸ  Route Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
app.get('/', (req, res) => {
    res.json({
        message: 'ğŸš€ Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„ Ø¬Ø§Ù‡Ø²!',
        endpoints: {
            upload: 'POST /api/upload',
            listFiles: 'GET /api/files/:bucket',
            deleteFile: 'DELETE /api/files/:bucket/:filename'
        },
        buckets: ['facebook-posts', 'facebook-images', 'facebook-videos', 'backups']
    });
});

// ğŸš€ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø³Ø±ÙØ±
const PORT = process.env.PORT || 3000;

async function startServer() {
    await initializeBuckets();
    
    app.listen(PORT, () => {
        console.log(`
ğŸ‰ Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„ ÙŠØ¹Ù…Ù„ Ø¨Ù†Ø¬Ø§Ø­!

ğŸ“ Ø§Ù„Ø³Ø±ÙØ±: http://localhost:${PORT}
ğŸ“¦ MinIO: http://localhost:9000

ğŸ“š Ø§Ù„Ø¥Ù†Ø¯Ø¨ÙˆÙŠÙ†ØªØ³ Ø§Ù„Ù…ØªØ§Ø­Ø©:
ğŸ“¤ Ø±ÙØ¹ Ù…Ù„Ù: POST /api/upload
ğŸ“‹ Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„ÙØ§Øª: GET /api/files/:bucket
ğŸ—‘ï¸ Ø­Ø°Ù Ù…Ù„Ù: DELETE /api/files/:bucket/:filename

âœ… Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…!
        `);
    });
}

startServer().catch(console.error);

module.exports = {
    minioClient,
    integratedUpload,
    getFilesList,
    deleteFile
};