// migrate-to-drive-single-file.js
const { google } = require('googleapis');
const fs = require('fs');
const path = require('path');

// ---------- Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ----------
const KEYFILEPATH = path.join(__dirname, 'google_service.json'); // Ø¶Ø¹ Ù‡Ù†Ø§ Ù…Ø³Ø§Ø± Service Account JSON
const SCOPES = ['https://www.googleapis.com/auth/drive'];

const LOCAL_FOLDER = path.join(__dirname, 'temp-uploads'); // Ù…Ø¬Ù„Ø¯ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
const DRIVE_FOLDER_ID = 'Ø¶Ø¹ Ù‡Ù†Ø§ Folder ID Ø¹Ù„Ù‰ Google Drive'; // Ø§Ù„ÙÙˆÙ„Ø¯Ø± Ø¹Ù„Ù‰ Drive

// ---------- ØªÙ‡ÙŠØ¦Ø© Google Drive ----------
const auth = new google.auth.GoogleAuth({
  keyFile: KEYFILEPATH,
  scopes: SCOPES
});

const drive = google.drive({ version: 'v3', auth });

// ---------- Ø¯Ø§Ù„Ø© Ø±ÙØ¹ Ù…Ù„Ù ----------
async function uploadFile(filePath, fileName, folderId) {
  const fileMetadata = { name: fileName };
  if (folderId) fileMetadata.parents = [folderId];

  const media = { body: fs.createReadStream(filePath) };

  try {
    const res = await drive.files.create({
      resource: fileMetadata,
      media: media,
      fields: 'id'
    });
    console.log(`âœ… Uploaded: ${fileName} (ID: ${res.data.id})`);
    return true;
  } catch (err) {
    console.error(`âŒ Failed to upload ${fileName}:`, err.message || err);
    return false;
  }
}

// ---------- Ø¯Ø§Ù„Ø© Ø­Ø°Ù Ù…Ù„Ù Ù…Ø­Ù„ÙŠ ----------
function deleteLocalFile(filePath) {
  fs.unlink(filePath, err => {
    if (err) console.error(`âŒ Failed to delete ${filePath}:`, err.message || err);
    else console.log(`ðŸ—‘ï¸ Deleted local file: ${filePath}`);
  });
}

// ---------- Ø§Ù„ØªÙ†ÙÙŠØ° ----------
(async () => {
  try {
    const files = fs.readdirSync(LOCAL_FOLDER);
    if (files.length === 0) return console.log('No files to upload.');

    for (const fileName of files) {
      const filePath = path.join(LOCAL_FOLDER, fileName);
      const success = await uploadFile(filePath, fileName, DRIVE_FOLDER_ID);
      if (success) deleteLocalFile(filePath);
    }

    console.log('ðŸŽ‰ All files processed.');
  } catch (err) {
    console.error('Error during migration:', err.message || err);
  }
})();
