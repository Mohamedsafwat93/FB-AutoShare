const express = require('express');
const os = require('os');
const fs = require('fs');
const path = require('path');
require('dotenv').config();

const app = express();
const PORT = process.env.PORT || 5000;

app.use(express.static(path.join(__dirname, 'public')));
app.use(express.json());

const LOG_FILE = path.join(__dirname, 'postsLog.json');

// Load posts from file or start empty
let posts = [];
if (fs.existsSync(LOG_FILE)) {
  posts = JSON.parse(fs.readFileSync(LOG_FILE));
}

let lastPost = posts[posts.length - 1] || null;

// Save posts to file (keep max 50)
function savePosts() {
  if (posts.length > 50) posts = posts.slice(-50);
  fs.writeFileSync(LOG_FILE, JSON.stringify(posts, null, 2));
}

// API: get last 10 posts
app.get('/api/posts', (req, res) => {
  res.json(posts.slice(-10).reverse());
});

// API: add new post
app.post('/api/posts', (req, res) => {
  const { message } = req.body;
  if (!message) return res.status(400).json({ error: 'Message required' });
  const post = { id: Date.now(), message, createdAt: new Date(), status: 'âœ… Success' };
  posts.push(post);
  lastPost = post;
  savePosts();
  res.json(post);
});

// API: delete post by ID
app.delete('/api/posts/:id', (req, res) => {
  const id = parseInt(req.params.id);
  posts = posts.filter(p => p.id !== id);
  savePosts();
  res.json({ success: true });
});

// API: repost last post
app.post('/api/repost', (req, res) => {
  if (!lastPost) return res.status(400).json({ error: 'No last post' });
  const newPost = { id: Date.now(), message: lastPost.message, createdAt: new Date(), status: 'â³ Pending' };
  posts.push(newPost);
  lastPost = newPost;

  // Simulate post result after 2 seconds
  setTimeout(() => {
    newPost.status = Math.random() > 0.1 ? 'âœ… Success' : 'âŒ Failed';
    savePosts();
  }, 2000);

  savePosts();
  res.json(newPost);
});

// API: server stats
app.get('/api/stats', (req, res) => {
  const totalMem = os.totalmem();
  const freeMem = os.freemem();
  const usedMem = totalMem - freeMem;
  const cpus = os.cpus();
  res.json({
    uptime: process.uptime(),
    memory: { total: totalMem, used: usedMem, free: freeMem },
    cpu: { model: cpus[0].model, cores: cpus.length }
  });
});

// Health check
app.get('/health', (req, res) => {
  res.json({ status: 'healthy', timestamp: new Date(), uptime: process.uptime() });
});

// Serve dashboard
app.get('/', (req, res) => {
  res.sendFile(path.join(__dirname, 'public', 'dashboard.html'));
});

app.listen(PORT, () => console.log(`ğŸš€ Server running on port ${PORT}`));