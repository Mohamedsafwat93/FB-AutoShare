const { google } = require('googleapis');
const fs = require('fs');
const path = require('path');

// ---------- Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ----------
const KEYFILEPATH = './google_service.json'; // Ù…Ù„Ù credentials
const SCOPES = ['https://www.googleapis.com/auth/drive'];
const LOCAL_FOLDER = './ITSolutions-MonthlyStorage'; // Ø§Ù„Ù…Ø¬Ù„Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ± Ø§Ù„Ù„ÙŠ ÙÙŠÙ‡ Ø§Ù„Ù…Ù„ÙØ§Øª
const FOLDER_ID = '1hByCXDjMMrYcWo5oAyqYqK_Jk603nZdL'; // Folder ID Ø¹Ù„Ù‰ Google Drive

// ---------- Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© ----------
const auth = new google.auth.GoogleAuth({
  keyFile: KEYFILEPATH,
  scopes: SCOPES
});

const drive = google.drive({ version: 'v3', auth });

// ---------- Ø¯Ø§Ù„Ø© Ø±ÙØ¹ Ù…Ù„Ù ----------
async function uploadFile(filePath, fileName) {
  const media = { body: fs.createReadStream(filePath) };
  try {
    const res = await drive.files.create({
      resource: { name: fileName, parents: [FOLDER_ID] },
      media: media,
      fields: 'id'
    });
    console.log(`âœ… Uploaded: ${fileName}`);
    return true;
  } catch (err) {
    console.error(`âŒ Failed: ${fileName} - ${err.message}`);
    return false;
  }
}

// ---------- Ø¯Ø§Ù„Ø© Ø­Ø°Ù Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© ÙÙŠ Ø§Ù„ÙÙˆÙ„Ø¯Ø± ----------
async function deleteAllFilesInFolder() {
  try {
    const res = await drive.files.list({
      q: `'${FOLDER_ID}' in parents`,
      fields: 'files(id, name)'
    });
    const files = res.data.files;
    for (const file of files) {
      await drive.files.delete({ fileId: file.id });
      console.log(`ðŸ—‘ Deleted old file: ${file.name}`);
    }
  } catch (err) {
    console.error('âŒ Error deleting old files:', err.message);
  }
}

// ---------- Ø§Ù„ØªÙ†ÙÙŠØ° ----------
(async () => {
  console.log('ðŸ“Œ Checking folder and cleaning old files...');
  await deleteAllFilesInFolder();

  const files = fs.readdirSync(LOCAL_FOLDER);
  console.log(`ðŸ“¤ Starting upload of ${files.length} files...`);
  for (const f of files) {
    await uploadFile(path.join(LOCAL_FOLDER, f), f);
  }
  console.log('ðŸŽ‰ All files processed!');
})();
